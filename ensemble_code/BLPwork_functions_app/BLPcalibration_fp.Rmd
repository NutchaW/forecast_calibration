---
title: "BLP Work"
author: "Nutcha Wattanachit"
date: "02/03/2020"
output: html_document
tables: yes
header-includes:
- \usepackage{tabular}
- \usepackage{hyperref}
- \usepackage{kableExtra}
- \usepackage{algorithm}
- \usepackage[noend]{algpseudocode}
- \usepackage{algorithm2e}
- \usepackage[ruled,vlined,linesnumbered]{algorithm2e}
---

```{r setup, include=FALSE}
library(tidyverse);library("cdcfluview");library(Matrix)
library(cowplot);library(data.table);library(reshape2)
library(gridExtra);library(ranger);library(xtable)
library(here);library(stats);library(mixtools)
library(ggforce);library(grid);library(FluSight)
library(rmutil);library(R.utils);library(knitr)
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, comment = FALSE, message=FALSE, fig.show= 'hold')
```

# Flu Forecasting Application
# note that 2017/18 might not be real time since i used branch end-of-2018-19
These are the test set results of the cross-validation process.

\begin{itemize}

\item The 2017/2018 season is excluded and will later be used as a prospective test season. The BLP and cBLP cross-validation process include season 2010/2011-2016/2017. Using leave-one-season-out cross-validation, each of the 2010/2011-2016/2017 seasons takes turn to be the test season with the other 6 seasons being the training seasons. So, we have 7 test seasons in the cross-validation process.

\item BLP Example: To obtain $\alpha$, $\beta$, and the weights for 21 component models with the 2010/2011 as a test season, I trained the BLP model on season 2011/2012-2016/2017. Then, for test season evaluation, I applied $\alpha$, $\beta$, and the weights I got from training in test season. Repeat this for all 7 seasons.

\item cBLP Example Part 1: Set the 2010/2011 as a test season. To apply the beta transformation on each of the component models, I optmized $\alpha$, $\beta$ that maximize the beta log-likelihood for each component model in the training seasons (2011/2012-2016/2017). Once I got all 21 pairs of $\alpha$ and $\beta$, I used them to beta-transform component models in the training seasons (2011/2012-2016/2017). This ends the component-wise part. 

\item cBLP Example Part 2: Now that I have 21 beta-transformed components, I can apply the usual BLP process on them. To obtain $\alpha$, $\beta$, and the 21 weights for the whole BLP ensemble, I trained BLP model on the training seasons (2011/2012-2016/2017). Then, for test season evaluation, I applied $\alpha$, $\beta$, and the weights I got from training in test season. Repeat this for all 7 seasons.

\end{itemize}

```{r, echo=FALSE}
source("BLPwork_functions/functions_app.R")
```

```{r}
# BLP inputs
# get all component diss
allDis<-read.csv("scores/scores.csv") %>%
  dplyr::filter(target!= "Season onset",target!="Season peak week")
allDis<-read.csv("scores/scores.csv")
scores<-read.csv("scores/scores-for-ensemble-paper.csv") 
truths<-read.csv("scores/target-multivals-20172018.csv") 
noncomp_lst<-c(unique(as.character(allDis$model_name))[grepl("-weights",unique(allDis$model_name))==TRUE]
               ,"UTAustin_edm","FluSight_unweighted_avg")
comp_main<-allDis %>%
  dplyr::filter(!(model_name %in% noncomp_lst)) %>%
  mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"), 
                         paste(year-1, year, sep= "/")))
levels(comp_main$model_name)[levels(comp_main$model_name)=="CUBMA"] <- "CU_BMA"
comp_main<-comp_main %>%
  select(-"year",-"forecast_week") %>%
  dcast(target+location + Season + calendar_week + bin_start_incl + bin_end_notincl ~ model_name, value.var="value")
comp_main<- comp_main[,c(1:6,13,7:12,14:15,20,17,16,18:19,21:27)]
comp_main2 <- gather(comp_main, model_name, value, 
                    CU_BMA:ReichLab_sarima_seasonal_difference_TRUE, factor_key=TRUE) %>%
  dplyr::filter(target!="Season peak week",target!="Season onset") 
# to save some computer memory
rm(allDis)
noncomp_lst2<-c(unique(as.character(scores$Model))[grepl("FSNetwork",unique(scores$Model))==TRUE]
               ,"UTAustin-edm","FluSight-unweighted_avg")
testSeason <- "2017/2018"
targets<-c(as.character(unique(comp_main2$target)))
model_list<-c(as.character(unique(comp_main2$model_name)))
wk_range<-c(1:18,43:53)
# get score
# ordered by season, week, location, model
scores_df<-scores %>% 
  dplyr::filter(!(Model %in% noncomp_lst2)) %>%
  dplyr::select(-"Multi.bin.score",-"Year",-"Model.Week") %>%
  dplyr::filter(Epiweek %in% wk_range, Target!="Season peak week",Target!="Season onset") %>%
  dcast(Target+Location + Season + Epiweek ~ Model, value.var="Score") 
# to save memory
rm(comp_main)
# get cdf for all train sets
comp_ecdf<-comp_main2 %>%
    dplyr::filter(Season!=testSeason,calendar_week %in% wk_range) %>%
    arrange(as.numeric(as.character(bin_start_incl)))
```

```{r}
# BLP inputs
# get all component diss
allDis<-read.csv("scores/allDis.csv") %>%
  dplyr::filter(target!= "Season onset",target!="Season peak week")
scores<-read.csv("scores/scores-for-ensemble-paper.csv") 
truths<-read.csv("scores/target-multivals-20172018.csv") 
noncomp_lst<-c(unique(as.character(allDis$model_name))[grepl("-weights",unique(allDis$model_name))==TRUE]
               ,"UTAustin_edm","FluSight_unweighted_avg")
comp_main<-allDis %>%
  dplyr::filter(!(model_name %in% noncomp_lst)) %>%
  mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"), 
                         paste(year-1, year, sep= "/")))
levels(comp_main$model_name)[levels(comp_main$model_name)=="CUBMA"] <- "CU_BMA"
comp_main<-comp_main %>%
  select(-"year",-"forecast_week") %>%
  dcast(target+location + Season + calendar_week + bin_start_incl + bin_end_notincl ~ model_name, value.var="value")
comp_main<- comp_main[,c(1:6,13,7:12,14:15,20,17,16,18:19,21:27)]
comp_main2 <- gather(comp_main, model_name, value, 
                    CU_BMA:ReichLab_sarima_seasonal_difference_TRUE, factor_key=TRUE) %>%
  dplyr::filter(target!="Season peak week",target!="Season onset") 
# to save some computer memory
rm(allDis)
noncomp_lst2<-c(unique(as.character(scores$Model))[grepl("FSNetwork",unique(scores$Model))==TRUE]
               ,"UTAustin-edm","FluSight-unweighted_avg")
testSeason <- "2017/2018"
targets<-c(as.character(unique(comp_main2$target)))
model_list<-c(as.character(unique(comp_main2$model_name)))
wk_range<-c(1:18,43:53)
# get score
# ordered by season, week, location, model
scores_df<-scores %>% 
  dplyr::filter(!(Model %in% noncomp_lst2)) %>%
  dplyr::select(-"Multi.bin.score",-"Year",-"Model.Week") %>%
  dplyr::filter(Epiweek %in% wk_range, Target!="Season peak week",Target!="Season onset") %>%
  dcast(Target+Location + Season + Epiweek ~ Model, value.var="Score") 
# to save memory
rm(comp_main)
# get cdf for all train sets
comp_ecdf<-comp_main2 %>%
    dplyr::filter(Season!=testSeason,calendar_week %in% wk_range) %>%
    arrange(as.numeric(as.character(bin_start_incl)))
```

## BLP to be looked at

```{r, echo=FALSE}
loc<-c("HHS Region 1","HHS Region 2","HHS Region 3","HHS Region 4",
       "HHS Region 5","HHS Region 6","HHS Region 7","HHS Region 8",
       "HHS Region 9","HHS Region 10","US National")
# BLP (Beta-transformed linear pool) combination ------------------------------
for(j in 1:7){
  for(i in 1:length(targets)){
    assign(paste0("t",i,"s",j),
           read.csv(paste0("./BLPdat/t",i,"s",j,".csv")) %>%
    as.matrix())
  }
}
scores_df2<-scores_df %>% dplyr::filter(Season!=testSeason) 
for(j in 1:length(unique(scores_df2$Season))){
  scores_df3<-scores_df2 %>% dplyr::filter(Season!= unique(scores_df2$Season)[j]) 
  for(i in 1:length(targets)){
    assign(paste0("c",i,"s",j),scores_df3 %>% 
    dplyr::filter(Target==targets[i])%>%
    dplyr::select(-"Target",-"Location",-"Epiweek",-"Season") %>%
    as.matrix())
  }
}

# combine for prediction on test set 
compCDF<-read.csv("./BLPdat/compCDF.csv")
comp_PCDF <- compCDF %>%
  arrange(match(model_name, model_list))
rm(compCDF)
# get bin in matrix
for(j in 1:length(unique(comp_PCDF$Season))){
  for(i in 1:length(targets)){
      comp_PCDFk<-comp_PCDF %>% 
        dplyr::filter(Season==unique(comp_PCDF$Season)[j],target==targets[i]) %>%
        dplyr::select(-"target",-"forecast_week",-"year",-"value")
      assign(paste0("cdf_mat",i,"s",j),  
             dcast(comp_PCDFk,
                   location + Season + calendar_week + bin_start_incl + bin_end_notincl ~ model_name,
                   value.var="cdf")) 
  }
}

for(j in 1:length(unique(comp_PCDF$Season))){
  for(i in 1:length(targets)){
      comp_PCDFk<-comp_PCDF %>% 
        dplyr::filter(Season==unique(comp_PCDF$Season)[j],target==targets[i]) %>%
        dplyr::select(-"target",-"forecast_week",-"year",-"cdf")
      assign(paste0("pdf_mat",i,"s",j),  
             dcast(comp_PCDFk,
                   location + Season + calendar_week + bin_start_incl + bin_end_notincl ~ model_name,
                   value.var="value")) 
  }
}
cdf_mat1s1<-cdf_mat1s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s2 <-cdf_mat1s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s3<-cdf_mat1s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s4<-cdf_mat1s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s5<-cdf_mat1s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s6<-cdf_mat1s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat1s7<-cdf_mat1s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

cdf_mat2s1<-cdf_mat2s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s2<-cdf_mat2s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s3<-cdf_mat2s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s4<-cdf_mat2s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s5<-cdf_mat2s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s6<-cdf_mat2s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat2s7<-cdf_mat2s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

cdf_mat3s1<-cdf_mat3s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s2<-cdf_mat3s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s3<-cdf_mat3s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s4<-cdf_mat3s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s5<-cdf_mat3s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s6<-cdf_mat3s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat3s7<-cdf_mat3s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

cdf_mat4s1<-cdf_mat4s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s2<-cdf_mat4s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s3<-cdf_mat4s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s4<-cdf_mat4s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s5<-cdf_mat4s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s6<-cdf_mat4s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat4s7<-cdf_mat4s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

cdf_mat5s1<-cdf_mat5s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s2<-cdf_mat5s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s3<-cdf_mat5s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s4<-cdf_mat5s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s5<-cdf_mat5s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s6<-cdf_mat5s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
cdf_mat5s7<-cdf_mat5s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()


pdf_mat1s1<-pdf_mat1s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s2 <-pdf_mat1s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s3<-pdf_mat1s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s4<-pdf_mat1s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s5<-pdf_mat1s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s6<-pdf_mat1s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat1s7<-pdf_mat1s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

pdf_mat2s1<-pdf_mat2s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s2<-pdf_mat2s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s3<-pdf_mat2s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s4<-pdf_mat2s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s5<-pdf_mat2s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s6<-pdf_mat2s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat2s7<-pdf_mat2s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

pdf_mat3s1<-pdf_mat3s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s2<-pdf_mat3s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s3<-pdf_mat3s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s4<-pdf_mat3s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s5<-pdf_mat3s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s6<-pdf_mat3s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat3s7<-pdf_mat3s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

pdf_mat4s1<-pdf_mat4s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s2<-pdf_mat4s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s3<-pdf_mat4s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s4<-pdf_mat4s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s5<-pdf_mat4s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s6<-pdf_mat4s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat4s7<-pdf_mat4s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()

pdf_mat5s1<-pdf_mat5s1 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s2<-pdf_mat5s2 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s3<-pdf_mat5s3 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s4<-pdf_mat5s4 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s5<-pdf_mat5s5 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s6<-pdf_mat5s6 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
pdf_mat5s7<-pdf_mat5s7 %>%
  group_by(Season, calendar_week, location) %>%
  arrange(match(location,loc)) %>%
  ungroup()
```

```{r}
# start running from here

# first 2 numbers are a,b for beta, the rest are weights
for(j in 1:length(unique(scores_df2$Season))){
  for(i in 1:length(targets)){
    assign(paste0("pt",i,"s",j),get_BLPparams(get(paste0("t",i,"s",j)),
                                              get(paste0("c",i,"s",j))))
  }
}

# separate by 
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets))
    assign(paste0("combBLP_test",j,"S",i),
           as.matrix(as.matrix(get(paste0("pdf_mat",j,"s",i))[,6:26]) %*% get(paste0("pt",j,"s",i))[3:23]*
                       dbeta(as.matrix(get(paste0("cdf_mat",j,"s",i))[,6:26]) %*%
                               get(paste0("pt",j,"s",i))[3:23],
                          shape1=get(paste0("pt",j,"s",i))[1],shape2=get(paste0("pt",j,"s",i))[2])))}


for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
  assign(paste0("full_combBLP_test",j,"S",i),
         data.frame(cbind(
           as.matrix(get(paste0("pdf_mat",j,"s",i)))[,1:5],get(paste0("combBLP_test",j,"S",i))
           )))}}

for(j in 1:length(targets)){
    assign(paste0("full_combBLP_test",j),
    rbind(get(paste0("full_combBLP_test",j,"S",1)),get(paste0("full_combBLP_test",j,"S",2)),
          get(paste0("full_combBLP_test",j,"S",3)),get(paste0("full_combBLP_test",j,"S",4)),
          get(paste0("full_combBLP_test",j,"S",5)),get(paste0("full_combBLP_test",j,"S",6)),
          get(paste0("full_combBLP_test",j,"S",7))
    ))}

for(j in 1:length(targets)){
  assign(paste0("full_combBLP_test",j),get(paste0("full_combBLP_test",j)) %>%
           mutate(binp=ifelse(bin_start_incl=="0.0",as.numeric(as.character(V6)),
                              diff(cumsum(as.numeric(as.character(lag(V6))))))))
}

for(j in 1:length(targets)){
    write.csv(get(paste0("full_combBLP_test",j)),
            file=paste0("./BLPdat/full_combBLP_test",j,".csv"), quote = FALSE, row.names = FALSE)}

for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("combBLP_trainS",i),
           matrix(c(get(paste0("t",1,"s",i)) %*% get(paste0("pt",1,"s",i))[3:23],
                    get(paste0("t",2,"s",i)) %*% get(paste0("pt",2,"s",i))[3:23],
                    get(paste0("t",3,"s",i)) %*% get(paste0("pt",3,"s",i))[3:23],
                    get(paste0("t",4,"s",i)) %*% get(paste0("pt",4,"s",i))[3:23],
                    get(paste0("t",5,"s",i)) %*% get(paste0("pt",5,"s",i))[3:23]),
                    ncol=5, byrow =FALSE,dimnames=NULL)) }

```

## Component-wise BLP

```{r}
# pdf on truth
loc<-c("HHS Region 1","HHS Region 2","HHS Region 3","HHS Region 4",
       "HHS Region 5","HHS Region 6","HHS Region 7","HHS Region 8",
       "HHS Region 9","HHS Region 10","US National")

# get different pdf train sets
truth1<-truths %>% dplyr::filter(Target==targets[1],Calendar.Week %in% wk_range) %>%
  dplyr::select(-"Year",-"Model.Week",-"Target")
truth2<-truths %>% dplyr::filter(Target==targets[2],Calendar.Week %in% wk_range) %>%
  dplyr::select(-"Year",-"Model.Week",-"Target")
truth3<-truths %>% dplyr::filter(Target==targets[3],Calendar.Week %in% wk_range) %>%
  dplyr::select(-"Year",-"Model.Week",-"Target")
truth4<-truths %>% dplyr::filter(Target==targets[4],Calendar.Week %in% wk_range) %>%
  dplyr::select(-"Year",-"Model.Week",-"Target")
truth5<-truths %>% dplyr::filter(Target==targets[5],Calendar.Week %in% wk_range) %>%
  dplyr::select(-"Year",-"Model.Week",-"Target")
#target 1
pdfol1_S1<-pdf_mat1s1 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup() %>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()

pdfol1_S2<-pdf_mat1s2 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol1_S3<-pdf_mat1s3 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol1_S4<-pdf_mat1s4 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol1_S5<-pdf_mat1s5 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol1_S6<-pdf_mat1s6 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol1_S7<-pdf_mat1s7 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
#target 2
pdfol2_S1<-pdf_mat2s1 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S2<-pdf_mat2s2 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S3<-pdf_mat2s3 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S4<-pdf_mat2s4 %>%
  left_join(truth1,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S5<-pdf_mat2s5 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S6<-pdf_mat2s6 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol2_S7<-pdf_mat2s7 %>%
  left_join(truth2,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()

#target 3
pdfol3_S1<-pdf_mat3s1 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S2<-pdf_mat3s2 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S3<-pdf_mat3s3 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S4<-pdf_mat3s4 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S5<-pdf_mat3s5 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S6<-pdf_mat3s6 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol3_S7<-pdf_mat3s7 %>%
  left_join(truth3,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
#target 4
pdfol4_S1<-pdf_mat4s1 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S2<-pdf_mat4s2 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S3<-pdf_mat4s3 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S4<-pdf_mat4s4 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S5<-pdf_mat4s5 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S6<-pdf_mat4s6 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol4_S7<-pdf_mat4s7 %>%
  left_join(truth4,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
#target 5
pdfol5_S1<-pdf_mat5s1 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S2<-pdf_mat5s2 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S3<-pdf_mat5s3 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S4<-pdf_mat5s4 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S5<-pdf_mat5s5 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S6<-pdf_mat5s6 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix()
pdfol5_S7<-pdf_mat5s7 %>%
  left_join(truth5,by=c("Season"="Season","calendar_week"="Calendar.Week","location"="Location")) %>%
  group_by(Season, calendar_week, location) %>%
  dplyr::filter(bin_start_incl==Valid.Bin_start_incl) %>%
  ungroup()%>%
  dplyr::select(-"Valid.Bin_start_incl",-"location",-"Season",-"bin_start_incl",-"bin_end_notincl",-"calendar_week") %>%
  as.matrix
# combine matrices for training 
pdfa1_S1<-rbind(pdfol1_S2,pdfol1_S3,pdfol1_S4,pdfol1_S5,pdfol1_S6,pdfol1_S7)
pdfa1_S2<-rbind(pdfol1_S1,pdfol1_S3,pdfol1_S4,pdfol1_S5,pdfol1_S6,pdfol1_S7)
pdfa1_S3<-rbind(pdfol1_S1,pdfol1_S2,pdfol1_S4,pdfol1_S5,pdfol1_S6,pdfol1_S7)
pdfa1_S4<-rbind(pdfol1_S1,pdfol1_S2,pdfol1_S3,pdfol1_S5,pdfol1_S6,pdfol1_S7)
pdfa1_S5<-rbind(pdfol1_S1,pdfol1_S2,pdfol1_S3,pdfol1_S4,pdfol1_S6,pdfol1_S7)
pdfa1_S6<-rbind(pdfol1_S1,pdfol1_S2,pdfol1_S3,pdfol1_S4,pdfol1_S5,pdfol1_S7)
pdfa1_S7<-rbind(pdfol1_S1,pdfol1_S2,pdfol1_S3,pdfol1_S4,pdfol1_S5,pdfol1_S6)

pdfa2_S1<-rbind(pdfol2_S2,pdfol2_S3,pdfol2_S4,pdfol2_S5,pdfol2_S6,pdfol2_S7)
pdfa2_S2<-rbind(pdfol2_S1,pdfol2_S3,pdfol2_S4,pdfol2_S5,pdfol2_S6,pdfol2_S7)
pdfa2_S3<-rbind(pdfol2_S1,pdfol2_S2,pdfol2_S4,pdfol2_S5,pdfol2_S6,pdfol2_S7)
pdfa2_S4<-rbind(pdfol2_S1,pdfol2_S2,pdfol2_S3,pdfol2_S5,pdfol2_S6,pdfol2_S7)
pdfa2_S5<-rbind(pdfol2_S1,pdfol2_S2,pdfol2_S3,pdfol2_S4,pdfol2_S6,pdfol2_S7)
pdfa2_S6<-rbind(pdfol2_S1,pdfol2_S2,pdfol2_S3,pdfol2_S4,pdfol2_S5,pdfol2_S7)
pdfa2_S7<-rbind(pdfol2_S1,pdfol2_S2,pdfol2_S3,pdfol2_S4,pdfol2_S5,pdfol2_S6)

pdfa3_S1<-rbind(pdfol3_S2,pdfol3_S3,pdfol3_S4,pdfol3_S5,pdfol3_S6,pdfol3_S7)
pdfa3_S2<-rbind(pdfol3_S1,pdfol3_S3,pdfol3_S4,pdfol3_S5,pdfol3_S6,pdfol3_S7)
pdfa3_S3<-rbind(pdfol3_S1,pdfol3_S2,pdfol3_S4,pdfol3_S5,pdfol3_S6,pdfol3_S7)
pdfa3_S4<-rbind(pdfol3_S1,pdfol3_S2,pdfol3_S3,pdfol3_S5,pdfol3_S6,pdfol3_S7)
pdfa3_S5<-rbind(pdfol3_S1,pdfol3_S2,pdfol3_S3,pdfol3_S4,pdfol3_S6,pdfol3_S7)
pdfa3_S6<-rbind(pdfol3_S1,pdfol3_S2,pdfol3_S3,pdfol3_S4,pdfol3_S5,pdfol3_S7)
pdfa3_S7<-rbind(pdfol3_S1,pdfol3_S2,pdfol3_S3,pdfol3_S4,pdfol3_S5,pdfol3_S6)

pdfa4_S1<-rbind(pdfol4_S2,pdfol4_S3,pdfol4_S4,pdfol4_S5,pdfol4_S6,pdfol4_S7)
pdfa4_S2<-rbind(pdfol4_S1,pdfol4_S3,pdfol4_S4,pdfol4_S5,pdfol4_S6,pdfol4_S7)
pdfa4_S3<-rbind(pdfol4_S1,pdfol4_S2,pdfol4_S4,pdfol4_S5,pdfol4_S6,pdfol4_S7)
pdfa4_S4<-rbind(pdfol4_S1,pdfol4_S2,pdfol4_S3,pdfol4_S5,pdfol4_S6,pdfol4_S7)
pdfa4_S5<-rbind(pdfol4_S1,pdfol4_S2,pdfol4_S3,pdfol4_S4,pdfol4_S6,pdfol4_S7)
pdfa4_S6<-rbind(pdfol4_S1,pdfol4_S2,pdfol4_S3,pdfol4_S4,pdfol4_S5,pdfol4_S7)
pdfa4_S7<-rbind(pdfol4_S1,pdfol4_S2,pdfol4_S3,pdfol4_S4,pdfol4_S5,pdfol4_S6)

pdfa5_S1<-rbind(pdfol5_S2,pdfol5_S3,pdfol5_S4,pdfol5_S5,pdfol5_S6,pdfol5_S7)
pdfa5_S2<-rbind(pdfol5_S1,pdfol5_S3,pdfol5_S4,pdfol5_S5,pdfol5_S6,pdfol5_S7)
pdfa5_S3<-rbind(pdfol5_S1,pdfol5_S2,pdfol5_S4,pdfol5_S5,pdfol5_S6,pdfol5_S7)
pdfa5_S4<-rbind(pdfol5_S1,pdfol5_S2,pdfol5_S3,pdfol5_S5,pdfol5_S6,pdfol5_S7)
pdfa5_S5<-rbind(pdfol5_S1,pdfol5_S2,pdfol5_S3,pdfol5_S4,pdfol5_S6,pdfol5_S7)
pdfa5_S6<-rbind(pdfol5_S1,pdfol5_S2,pdfol5_S3,pdfol5_S4,pdfol5_S5,pdfol5_S7)
pdfa5_S7<-rbind(pdfol5_S1,pdfol5_S2,pdfol5_S3,pdfol5_S4,pdfol5_S5,pdfol5_S6)
```

```{r}
# run model
# cBLP inputs
for(k in 1:length(targets)){
  for(j in 1:length(unique(scores_df2$Season))){
    assign(paste0("indt",k,"s",j),c())
    for(i in 1:length(model_list)){
      n_ab<-get_indivBparams(get(paste0("t",k,"s",j))[,i],get(paste0("c",k,"s",j))[,i])
      assign(paste0("indt",k,"s",j),rbind(get(paste0("indt",k,"s",j)),n_ab))}}}

# first 2 numbers are a,b for beta
for(j in 1:length(unique(scores_df2$Season))){
  for(i in 1:length(targets)){
    assign(paste0("cpt",i,"s",j),
           get_cBLPparams(get(paste0("t",i,"s",j)),
                          get(paste0("pdfa",i,"_S",j)),
                          get(paste0("indt",i,"s",j))))
  }
}

# fix infinity in dbeta
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
    assign(paste0("beta_pdf",j,"S",i),
           as.matrix(get(paste0("cdf_mat",j,"s",i))[,6:26])
    )}}

## Should have named them cdf....

beta_pdf1S1[isZero(beta_pdf1S1)]<-.Machine$double.xmin
beta_pdf1S2[isZero(beta_pdf1S2)]<-.Machine$double.xmin
beta_pdf1S3[isZero(beta_pdf1S3)]<-.Machine$double.xmin
beta_pdf1S4[isZero(beta_pdf1S4)]<-.Machine$double.xmin
beta_pdf1S5[isZero(beta_pdf1S5)]<-.Machine$double.xmin
beta_pdf1S6[isZero(beta_pdf1S6)]<-.Machine$double.xmin
beta_pdf1S7[isZero(beta_pdf1S7)]<-.Machine$double.xmin

beta_pdf2S1[isZero(beta_pdf2S1)]<-.Machine$double.xmin
beta_pdf2S2[isZero(beta_pdf2S2)]<-.Machine$double.xmin
beta_pdf2S3[isZero(beta_pdf2S3)]<-.Machine$double.xmin
beta_pdf2S4[isZero(beta_pdf2S4)]<-.Machine$double.xmin
beta_pdf2S5[isZero(beta_pdf2S5)]<-.Machine$double.xmin
beta_pdf2S6[isZero(beta_pdf2S6)]<-.Machine$double.xmin
beta_pdf2S7[isZero(beta_pdf2S7)]<-.Machine$double.xmin

beta_pdf3S1[isZero(beta_pdf3S1)]<-.Machine$double.xmin
beta_pdf3S2[isZero(beta_pdf3S2)]<-.Machine$double.xmin
beta_pdf3S3[isZero(beta_pdf3S3)]<-.Machine$double.xmin
beta_pdf3S4[isZero(beta_pdf3S4)]<-.Machine$double.xmin
beta_pdf3S5[isZero(beta_pdf3S5)]<-.Machine$double.xmin
beta_pdf3S6[isZero(beta_pdf3S6)]<-.Machine$double.xmin
beta_pdf3S7[isZero(beta_pdf3S7)]<-.Machine$double.xmin

beta_pdf4S1[isZero(beta_pdf4S1)]<-.Machine$double.xmin
beta_pdf4S2[isZero(beta_pdf4S2)]<-.Machine$double.xmin
beta_pdf4S3[isZero(beta_pdf4S3)]<-.Machine$double.xmin
beta_pdf4S4[isZero(beta_pdf4S4)]<-.Machine$double.xmin
beta_pdf4S5[isZero(beta_pdf4S5)]<-.Machine$double.xmin
beta_pdf4S6[isZero(beta_pdf4S6)]<-.Machine$double.xmin
beta_pdf4S7[isZero(beta_pdf4S7)]<-.Machine$double.xmin

beta_pdf5S1[isZero(beta_pdf5S1)]<-.Machine$double.xmin
beta_pdf5S2[isZero(beta_pdf5S2)]<-.Machine$double.xmin
beta_pdf5S3[isZero(beta_pdf5S3)]<-.Machine$double.xmin
beta_pdf5S4[isZero(beta_pdf5S4)]<-.Machine$double.xmin
beta_pdf5S5[isZero(beta_pdf5S5)]<-.Machine$double.xmin
beta_pdf5S6[isZero(beta_pdf5S6)]<-.Machine$double.xmin
beta_pdf5S7[isZero(beta_pdf5S7)]<-.Machine$double.xmin

# replace 1 with 0.9999999
beta_pdf1S1[beta_pdf1S1==1]<-1-1e-07
beta_pdf1S2[beta_pdf1S2==1]<-1-1e-07
beta_pdf1S3[beta_pdf1S3==1]<-1-1e-07
beta_pdf1S4[beta_pdf1S4==1]<-1-1e-07
beta_pdf1S5[beta_pdf1S5==1]<-1-1e-07
beta_pdf1S6[beta_pdf1S6==1]<-1-1e-07
beta_pdf1S7[beta_pdf1S7==1]<-1-1e-07

beta_pdf2S1[beta_pdf2S1==1]<-1-1e-07
beta_pdf2S2[beta_pdf2S2==1]<-1-1e-07
beta_pdf2S3[beta_pdf2S3==1]<-1-1e-07
beta_pdf2S4[beta_pdf2S4==1]<-1-1e-07
beta_pdf2S5[beta_pdf2S5==1]<-1-1e-07
beta_pdf2S6[beta_pdf2S6==1]<-1-1e-07
beta_pdf2S7[beta_pdf2S7==1]<-1-1e-07

beta_pdf3S1[beta_pdf3S1==1]<-1-1e-07
beta_pdf3S2[beta_pdf3S2==1]<-1-1e-07
beta_pdf3S3[beta_pdf3S3==1]<-1-1e-07
beta_pdf3S4[beta_pdf3S4==1]<-1-1e-07
beta_pdf3S5[beta_pdf3S5==1]<-1-1e-07
beta_pdf3S6[beta_pdf3S6==1]<-1-1e-07
beta_pdf3S7[beta_pdf3S7==1]<-1-1e-07

beta_pdf4S1[beta_pdf4S1==1]<-1-1e-07
beta_pdf4S2[beta_pdf4S2==1]<-1-1e-07
beta_pdf4S3[beta_pdf4S3==1]<-1-1e-07
beta_pdf4S4[beta_pdf4S4==1]<-1-1e-07
beta_pdf4S5[beta_pdf4S5==1]<-1-1e-07
beta_pdf4S6[beta_pdf4S6==1]<-1-1e-07
beta_pdf4S7[beta_pdf4S7==1]<-1-1e-07

beta_pdf5S1[beta_pdf5S1==1]<-1-1e-07
beta_pdf5S2[beta_pdf5S2==1]<-1-1e-07
beta_pdf5S3[beta_pdf5S3==1]<-1-1e-07
beta_pdf5S4[beta_pdf5S4==1]<-1-1e-07
beta_pdf5S5[beta_pdf5S5==1]<-1-1e-07
beta_pdf5S6[beta_pdf5S6==1]<-1-1e-07
beta_pdf5S7[beta_pdf5S7==1]<-1-1e-07
# first beta and second beta in pdf
# second cdf inside
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
assign(paste0("beta_cdf",j,"S",i),
       pbeta(get(paste0("beta_pdf",j,"S",i)),
             shape1=get(paste0("indt",j,"s",i))[,1],
             shape2=get(paste0("indt",j,"s",i))[,2])
)}}
#second pdf
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
assign(paste0("beta_pdf2",j,"S",i),
       dbeta(get(paste0("beta_cdf",j,"S",i))%*% get(paste0("cpt",j,"s",i))[3:23],
             shape1=get(paste0("cpt",j,"s",i))[1],
             shape2=get(paste0("cpt",j,"s",i))[2])
)}}
# first
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
assign(paste0("beta_pdf",j,"S",i),
       dbeta(get(paste0("beta_pdf",j,"S",i)),
             shape1=get(paste0("indt",j,"s",i))[,1],
             shape2 =get(paste0("indt",j,"s",i))[,2])
)}}


# first multiplication before the weights
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){ assign(paste0("prod",j,"S",i),
as.matrix(get(paste0("pdf_mat",j,"s",i))[,6:26])*get(paste0("beta_pdf",j,"S",i))
  )}}

# separate by 
for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
    assign(paste0("combCBLP_test",j,"S",i),
           as.matrix((get(paste0("prod",j,"S",i)) %*% get(paste0("cpt",j,"s",i))[3:23])
             *get(paste0("beta_pdf2",j,"S",i)))
           )}}

for(i in 1:length(unique(scores_df2$Season))){
  for(j in 1:length(targets)){
  assign(paste0("full_combCBLP_test",j,"S",i),
         data.frame(cbind(
           as.matrix(get(paste0("pdf_mat",j,"s",i)))[,1:5],get(paste0("combCBLP_test",j,"S",i))
           )))}}

for(j in 1:length(targets)){
    assign(paste0("full_combCBLP_test",j),
    rbind(get(paste0("full_combCBLP_test",j,"S",1)),get(paste0("full_combCBLP_test",j,"S",2)),
          get(paste0("full_combCBLP_test",j,"S",3)),get(paste0("full_combCBLP_test",j,"S",4)),
          get(paste0("full_combCBLP_test",j,"S",5)),get(paste0("full_combCBLP_test",j,"S",6)),
          get(paste0("full_combCBLP_test",j,"S",7))
          ))}

for(j in 1:length(targets)){
  assign(paste0("full_combCBLP_test",j),get(paste0("full_combCBLP_test",j)) %>%
           mutate(binp=ifelse(bin_start_incl=="0.0",as.numeric(as.character(V6)),
                              diff(cumsum(as.numeric(as.character(lag(V6))))))))
}
# for(j in 1:length(targets)){
#     write.csv(get(paste0("full_combCBLP_test",j)),
#             file=paste0("./BLPdat/full_combCBLP_test",j,".csv"), quote = FALSE, row.names = FALSE)}

# for in-sample
for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("combCBLP_trainS",i),
           matrix(c(get(paste0("t",1,"s",i)) %*% get(paste0("cpt",1,"s",i))[3:23],
                    get(paste0("t",2,"s",i)) %*% get(paste0("cpt",2,"s",i))[3:23],
                    get(paste0("t",3,"s",i)) %*% get(paste0("cpt",3,"s",i))[3:23],
                    get(paste0("t",4,"s",i)) %*% get(paste0("cpt",4,"s",i))[3:23],
                    get(paste0("t",5,"s",i)) %*% get(paste0("cpt",5,"s",i))[3:23]),
                    ncol=5, byrow =FALSE,dimnames=NULL)) }
```

## SLP

# ```{r, echo=FALSE}
# # SLP inputs
# med_comp<-read.csv("scores/point_ests_adj-w20172018.csv") %>%
#   dplyr::filter(target != "Season onset",target != "Season peak week",
#                 calendar_week %in% wk_range,Season!=testSeason) %>%
#   dplyr::filter(!(model_name %in% noncomp_lst)) %>%
#   mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"),
#                          paste(year-1, year, sep= "/"))) %>%
#   dplyr::filter(target==targets[1]) %>%
#   select("location","calendar_week","model_name","Season","target","err","value")
# levels(med_comp$model_name)[levels(med_comp$model_name)=="CUBMA"] <- "CU_BMA"
# med_comp$err<-round(med_comp$err,1)
# med_comp$value<-round(med_comp$value,1)
# # arrange rows
# med_comp<- med_comp %>% arrange(factor(model_name, levels = model_list))
# 
# # running to get params part
# for(j in 1:length(unique(med_comp$Season))){
#   for(i in 1:length(targets)){
#     comp_ecdf2<-comp_ecdf %>%
#       dplyr::filter(target==targets[i],Season==unique(med_comp$Season)[j])
#     comp_ecdf2$bin_start_incl<-as.numeric(as.character(comp_ecdf2$bin_start_incl))
#     med_comp2<-med_comp %>%
#       dplyr::filter(target==targets[i],Season==unique(med_comp$Season)[j])
#     assign(paste0("spt",i,"s",j),get_SLPparams(comp_ecdf2,med_comp2))
#   }
# }
# # separate by 
# for(i in 1:length(unique(scores_df2$Season))){
#   for(j in 1:length(targets))
#     assign(paste0("combSLP_test",j,"S",i),
#            as.matrix(as.matrix(get(paste0("pdf_mat",j,"s",i))[,6:26]) %*% get(paste0("pt",j,"s",i))[3:23]*
#                        dbeta(as.matrix(get(paste0("cdf_mat",j,"s",i))[,6:26]) %*%
#                                get(paste0("pt",j,"s",i))[3:23],
#                           shape1=get(paste0("pt",j,"s",i))[1:2],shape2=get(paste0("pt",j,"s",i))[1:2])))}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   for(j in 1:length(targets)){
#   assign(paste0("full_combSLP_test",j,"S",i),
#          data.frame(cbind(
#            as.matrix(get(paste0("pdf_mat",j,"s",i)))[,1:5],get(paste0("combSLP_test",j,"S",i))
#            )))}}
# 
# for(j in 1:length(targets)){
#     assign(paste0("full_combSLP_test",j),
#     rbind(get(paste0("full_combSLP_test",j,"S",1)),get(paste0("full_combSLP_test",j,"S",2)),
#           get(paste0("full_combSLP_test",j,"S",3)),get(paste0("full_combSLP_test",j,"S",4)),
#           get(paste0("full_combSLP_test",j,"S",5)),get(paste0("full_combSLP_test",j,"S",6)),
#           get(paste0("full_combSLP_test",j,"S",7))
#           ))}
# 
# for(j in 1:length(targets)){
#     write.csv(get(paste0("full_combSLP_test",j)),
#             file=paste0("./SLPdat/full_combSLP_test",j,".csv"), quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#     assign(paste0("combSLP_trainS",i),
#            matrix(c(get(paste0("t",1,"s",i)) %*% get(paste0("pt",1,"s",i))[3:23],
#                     get(paste0("t",2,"s",i)) %*% get(paste0("pt",2,"s",i))[3:23],
#                     get(paste0("t",3,"s",i)) %*% get(paste0("pt",3,"s",i))[3:23],
#                     get(paste0("t",4,"s",i)) %*% get(paste0("pt",4,"s",i))[3:23],
#                     get(paste0("t",5,"s",i)) %*% get(paste0("pt",5,"s",i))[3:23]),
#                     ncol=5, byrow =FALSE,dimnames=NULL)) }
# ```


## Component-wise SLP

### Cross-Validation Evaluation

Explore PIT plots of component models and TW ensemble.

```{r}
# prep data
truths1<-truths %>%
  dplyr::filter(Season!=testSeason,Target!="Season onset",Target!="Season peak week",
                Calendar.Week %in% wk_range)

for(j in 1:7){
  for(i in 1:length(targets)){
    assign(paste0("tt",i,"s",j),
           read.csv(paste0("./BLPdat/tt",i,"s",j,".csv")) %>%
    as.matrix())
  }
}
# change from factor to interger
#BLP
full_combBLP_test1$calendar_week<-as.integer(as.character(full_combBLP_test1$calendar_week))
full_combBLP_test2$calendar_week<-as.integer(as.character(full_combBLP_test2$calendar_week))
full_combBLP_test3$calendar_week<-as.integer(as.character(full_combBLP_test3$calendar_week))
full_combBLP_test4$calendar_week<-as.integer(as.character(full_combBLP_test4$calendar_week))
full_combBLP_test5$calendar_week<-as.integer(as.character(full_combBLP_test5$calendar_week))
full_combBLP_test1$bin_start_incl<-as.numeric(as.character(full_combBLP_test1$bin_start_incl))
full_combBLP_test2$bin_start_incl<-as.numeric(as.character(full_combBLP_test2$bin_start_incl))
full_combBLP_test3$bin_start_incl<-as.numeric(as.character(full_combBLP_test3$bin_start_incl))
full_combBLP_test4$bin_start_incl<-as.numeric(as.character(full_combBLP_test4$bin_start_incl))
full_combBLP_test5$bin_start_incl<-as.numeric(as.character(full_combBLP_test5$bin_start_incl))
# CBLP
full_combCBLP_test1$calendar_week<-as.integer(as.character(full_combCBLP_test1$calendar_week))
full_combCBLP_test2$calendar_week<-as.integer(as.character(full_combCBLP_test2$calendar_week))
full_combCBLP_test3$calendar_week<-as.integer(as.character(full_combCBLP_test3$calendar_week))
full_combCBLP_test4$calendar_week<-as.integer(as.character(full_combCBLP_test4$calendar_week))
full_combCBLP_test5$calendar_week<-as.integer(as.character(full_combCBLP_test5$calendar_week))
full_combCBLP_test1$bin_start_incl<-as.numeric(as.character(full_combCBLP_test1$bin_start_incl))
full_combCBLP_test2$bin_start_incl<-as.numeric(as.character(full_combCBLP_test2$bin_start_incl))
full_combCBLP_test3$bin_start_incl<-as.numeric(as.character(full_combCBLP_test3$bin_start_incl))
full_combCBLP_test4$bin_start_incl<-as.numeric(as.character(full_combCBLP_test4$bin_start_incl))
full_combCBLP_test5$bin_start_incl<-as.numeric(as.character(full_combCBLP_test5$bin_start_incl))

# log score
for(j in 1:length(targets)){
    true<-truths1 %>% dplyr::filter(Target==targets[j]) 
    assign(paste0("full_combBLP_test",j),
           left_join(get(paste0("full_combBLP_test",j)),true,
                     by=c("calendar_week"="Calendar.Week","location"="Location","Season"="Season")))
    assign(paste0("full_combCBLP_test",j),
         left_join(get(paste0("full_combCBLP_test",j)),true,
                    by=c("calendar_week"="Calendar.Week","location"="Location","Season"="Season")))
    }
# BLP
full_combBLP_test1<-full_combBLP_test1[full_combBLP_test1$bin_start_incl==full_combBLP_test1$Valid.Bin_start_incl,]
full_combBLP_test2<-full_combBLP_test2[full_combBLP_test2$bin_start_incl==full_combBLP_test2$Valid.Bin_start_incl,]
full_combBLP_test3<-full_combBLP_test3[full_combBLP_test3$bin_start_incl==full_combBLP_test3$Valid.Bin_start_incl,]
full_combBLP_test4<-full_combBLP_test4[full_combBLP_test4$bin_start_incl==full_combBLP_test4$Valid.Bin_start_incl,]
full_combBLP_test5<-full_combBLP_test5[full_combBLP_test5$bin_start_incl==full_combBLP_test5$Valid.Bin_start_incl,]
# cBLP
full_combCBLP_test1<-full_combCBLP_test1[full_combCBLP_test1$bin_start_incl==full_combCBLP_test1$Valid.Bin_start_incl,]
full_combCBLP_test2<-full_combCBLP_test2[full_combCBLP_test2$bin_start_incl==full_combCBLP_test2$Valid.Bin_start_incl,]
full_combCBLP_test3<-full_combCBLP_test3[full_combCBLP_test3$bin_start_incl==full_combCBLP_test3$Valid.Bin_start_incl,]
full_combCBLP_test4<-full_combCBLP_test4[full_combCBLP_test4$bin_start_incl==full_combCBLP_test4$Valid.Bin_start_incl,]
full_combCBLP_test5<-full_combCBLP_test5[full_combCBLP_test5$bin_start_incl==full_combCBLP_test5$Valid.Bin_start_incl,]

for(j in 1:length(targets)){
    assign(paste0("full_combBLP_test",j),
           mutate(get(paste0("full_combBLP_test",j)),logS=log(as.numeric(as.character(V6)))))
      assign(paste0("full_combCBLP_test",j),
           mutate(get(paste0("full_combCBLP_test",j)),logS=log(as.numeric(as.character(V6)))))
      # assign(paste0("full_combBLP_test",j),
      #      mutate(get(paste0("full_combBLP_test",j)),logS=log(binp)))
      # assign(paste0("full_combCBLP_test",j),
      #      mutate(get(paste0("full_combCBLP_test",j)),logS=log(binp)))
  }

# sum by target-season and by target scross season
for(j in 1:length(targets)){
    d<-get(paste0("full_combBLP_test",j))
    assign(paste0("meanLSbySeason",j),aggregate(d[,ncol(d)],list(d$Season), mean))
}
FSN_score<-scores %>% dplyr::filter(Model=="FSNetwork-TW",Season!=testSeason,Epiweek %in% wk_range)
for(j in 1:length(targets)){
    d<-get(paste0("meanLSbySeason",j))
    FSN_score2<-FSN_score %>% dplyr::filter(Target==targets[j])
    names(d)[2]<-"BLP"   
    d$FSN_TW<-aggregate(FSN_score2[,8],list(FSN_score2$Season), mean)$x
    e<-get(paste0("full_combCBLP_test",j))
    d$cBLP<-aggregate(e[,ncol(e)],list(e$Season), mean)$x
    assign(paste0("meanLSbySeason",j),d)
}
for(i in 1:length(targets)){
  assign(paste0("avg",i),c("Average",colMeans(get(paste0("meanLSbySeason",i))[,2:4])))
    assign(paste0("meanLSbySeason",i),rbind(get(paste0("meanLSbySeason",i)),get(paste0("avg",i))))
    as.character(get(paste0("meanLSbySeason",i))[,1])
    as.numeric(as.character(get(paste0("meanLSbySeason",i))[,2:4]))
}
meanLS<-rbind(meanLSbySeason1[8,],meanLSbySeason2[8,],
              meanLSbySeason3[8,],meanLSbySeason4[8,],meanLSbySeason5[8,])
names(meanLS)[1]<-"Target"
meanLS$Target<-targets
meanLS$BLP<-round(as.numeric(meanLS$BLP),3)
meanLS$FSN_TW<-round(as.numeric(meanLS$FSN_TW),3)
meanLS$cBLP<-round(as.numeric(meanLS$cBLP),3)

# START here!!!
# make BLP and cBLP combined into pits
#BLP
for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("PIT_BLP_test_S",i),
           matrix(c(pbeta(as.matrix(get(paste0("tt",1,"s",i))) %*%
                            get(paste0("pt",1,"s",i))[3:23], 
                          shape1 = get(paste0("pt",1,"s",i))[1], shape2 = get(paste0("pt",1,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",2,"s",i))) %*%
                            get(paste0("pt",2,"s",i))[3:23], 
                          shape1 = get(paste0("pt",2,"s",i))[1], shape2 = get(paste0("pt",2,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",3,"s",i))) %*%
                            get(paste0("pt",3,"s",i))[3:23], 
                          shape1 = get(paste0("pt",3,"s",i))[1], shape2 = get(paste0("pt",3,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",4,"s",i))) %*%
                            get(paste0("pt",4,"s",i))[3:23], 
                          shape1 = get(paste0("pt",4,"s",i))[1], shape2 = get(paste0("pt",4,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",5,"s",i))) %*%
                            get(paste0("pt",5,"s",i))[3:23], 
                          shape1 = get(paste0("pt",5,"s",i))[1], shape2 = get(paste0("pt",5,"s",i))[2])
           ), ncol=5, byrow =FALSE,dimnames=NULL)) }

# in semple check
for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("PIT_BLP_train_S",i),
           matrix(c(pbeta(get(paste0("combBLP_trainS",i))[,1], 
                          shape1 = get(paste0("pt",1,"s",i))[1], shape2 = get(paste0("pt",1,"s",i))[2]),
                    pbeta(get(paste0("combBLP_trainS",i))[,2], 
                          shape1 = get(paste0("pt",2,"s",i))[1], shape2 = get(paste0("pt",2,"s",i))[2]),
                    pbeta(get(paste0("combBLP_trainS",i))[,3], 
                          shape1 = get(paste0("pt",3,"s",i))[1], shape2 = get(paste0("pt",3,"s",i))[2]),
                    pbeta(get(paste0("combBLP_trainS",i))[,4], 
                          shape1 = get(paste0("pt",4,"s",i))[1], shape2 = get(paste0("pt",4,"s",i))[2]),
                    pbeta(get(paste0("combBLP_trainS",i))[,5], 
                          shape1 = get(paste0("pt",5,"s",i))[1], shape2 = get(paste0("pt",5,"s",i))[2])
           ), ncol=5, byrow =FALSE,dimnames=NULL)) }


#cBLP
for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("PIT_CBLP_test_S",i),
           matrix(c(pbeta(as.matrix(get(paste0("tt",1,"s",i))) %*%
                            get(paste0("cpt",1,"s",i))[3:23], 
                          shape1 = get(paste0("cpt",1,"s",i))[1], shape2 = get(paste0("cpt",1,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",2,"s",i))) %*%
                            get(paste0("cpt",2,"s",i))[3:23], 
                          shape1 = get(paste0("cpt",2,"s",i))[1], shape2 = get(paste0("cpt",2,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",3,"s",i))) %*%
                            get(paste0("cpt",3,"s",i))[3:23], 
                          shape1 = get(paste0("cpt",3,"s",i))[1], shape2 = get(paste0("cpt",3,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",4,"s",i))) %*%
                            get(paste0("cpt",4,"s",i))[3:23], 
                          shape1 = get(paste0("cpt",4,"s",i))[1], shape2 = get(paste0("cpt",4,"s",i))[2]),
                    pbeta(as.matrix(get(paste0("tt",5,"s",i))) %*%
                            get(paste0("cpt",5,"s",i))[3:23], 
                          shape1 = get(paste0("cpt",5,"s",i))[1], shape2 = get(paste0("cpt",5,"s",i))[2])
           ), ncol=5, byrow =FALSE,dimnames=NULL)) }

# in semple check
for(i in 1:length(unique(scores_df2$Season))){
    assign(paste0("PIT_CBLP_train_S",i),
           matrix(c(pbeta(get(paste0("combCBLP_trainS",i))[,1], 
                          shape1 = get(paste0("cpt",1,"s",i))[1], shape2 = get(paste0("cpt",1,"s",i))[2]),
                    pbeta(get(paste0("combCBLP_trainS",i))[,2], 
                          shape1 = get(paste0("cpt",2,"s",i))[1], shape2 = get(paste0("cpt",2,"s",i))[2]),
                    pbeta(get(paste0("combCBLP_trainS",i))[,3], 
                          shape1 = get(paste0("cpt",3,"s",i))[1], shape2 = get(paste0("cpt",3,"s",i))[2]),
                    pbeta(get(paste0("combCBLP_trainS",i))[,4], 
                          shape1 = get(paste0("cpt",4,"s",i))[1], shape2 = get(paste0("cpt",4,"s",i))[2]),
                    pbeta(get(paste0("combCBLP_trainS",i))[,5], 
                          shape1 = get(paste0("cpt",5,"s",i))[1], shape2 = get(paste0("cpt",5,"s",i))[2])
           ), ncol=5, byrow =FALSE,dimnames=NULL)) }

FSTW<-read.csv("scores/allDis.csv") %>%
  dplyr::filter(target != "Season onset",target!="Season peak week",
                model_name=="target-based-weights") 
FSTW<- FSTW %>%
  mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"), 
                         paste(year-1, year, sep= "/"))) %>%
  dplyr::filter(Season!= testSeason,calendar_week %in% wk_range)
  
# compared to FSN-TW
PIT_FSTW_S1<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S1))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[1])
  PIT_FSTW_S1[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S2<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S2))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[2])
  PIT_FSTW_S2[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S3<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S3))
for(i in 1:length(targets)){
  FSTW3<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[3])
  PIT_FSTW_S3[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S4<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S4))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[4])
  PIT_FSTW_S4[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S5<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S5))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[5])
  PIT_FSTW_S5[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S6<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S6))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[6])
  PIT_FSTW_S6[,i]<-target_pit_values(FSTW2, targets[i])
}
PIT_FSTW_S7<-matrix(NA,ncol=5,nrow=nrow(PIT_BLP_test_S7))
for(i in 1:length(targets)){
  FSTW2<-FSTW %>% dplyr::filter(Season== unique(FSTW$Season)[7])
  PIT_FSTW_S7[,i]<-target_pit_values(FSTW2, targets[i])
}

# individual beta pits
# for(i in 1:length(unique(scores_df2$Season))){
#   for(j in 1:length(model_list)){
#         assign(paste0("PIT_Beta_m",j,"_test_S",i),
#            matrix(c(pbeta(get(paste0("tt1s",i))[,1], 
#                           shape1 = get(paste0("indt",1,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",1,"s",i))[j,2]),
#                     pbeta(get(paste0("tt2s",i))[,2], 
#                           shape1 = get(paste0("indt",2,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",2,"s",i))[j,2]),
#                     pbeta(get(paste0("tt3s",i))[,3], 
#                           shape1 = get(paste0("indt",3,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",3,"s",i))[j,2]),
#                     pbeta(get(paste0("tt4s",i))[,4], 
#                           shape1 = get(paste0("indt",4,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",4,"s",i))[j,2]),
#                     pbeta(get(paste0("tt5s",i))[,5], 
#                           shape1 = get(paste0("indt",5,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",5,"s",i))[j,2])
#            ), ncol=5, byrow =FALSE,dimnames=NULL)) }
# }
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   for(j in 1:length(model_list)){
#         assign(paste0("PIT_Beta_m",j,"_train_S",i),
#            matrix(c(pbeta(get(paste0("t1s",i))[,1], 
#                           shape1 = get(paste0("indt",1,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",1,"s",i))[j,2]),
#                     pbeta(get(paste0("t2s",i))[,2], 
#                           shape1 = get(paste0("indt",2,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",2,"s",i))[j,2]),
#                     pbeta(get(paste0("t3s",i))[,3], 
#                           shape1 = get(paste0("indt",3,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",3,"s",i))[j,2]),
#                     pbeta(get(paste0("t4s",i))[,4], 
#                           shape1 = get(paste0("indt",4,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",4,"s",i))[j,2]),
#                     pbeta(get(paste0("t5s",i))[,5], 
#                           shape1 = get(paste0("indt",5,"s",i))[j,1], 
#                           shape2 = get(paste0("indt",5,"s",i))[j,2])
#            ), ncol=5, byrow =FALSE,dimnames=NULL)) }
#   }

#### saving and plotting

# for(i in 1:length(unique(scores_df2$Season))){
#   write.csv(data.frame(get(paste0("PIT_BLP_test_S",i))), 
#             file=paste0("./BLPdat/PIT_BLP_test_S",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   write.csv(data.frame(get(paste0("PIT_BLP_train_S",i))),
#             file=paste0("./BLPdat/PIT_BLP_train_S",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   write.csv(data.frame(get(paste0("PIT_CBLP_test_S",i))), 
#             file=paste0("./BLPdat/PIT_CBLP_test_S",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   write.csv(data.frame(get(paste0("PIT_CBLP_train_S",i))), 
#             file=paste0("./BLPdat/PIT_CBLP_train_S",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:length(unique(scores_df2$Season))){
#   write.csv(data.frame(get(paste0("PIT_FSTW_S",i))), 
#             file=paste0("./BLPdat/PIT_FSTW_S",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}
# 
# for(i in 1:5){
#   write.csv(get(paste0("meanLSbySeason",i)), 
#             file=paste0("./BLPdat/meanLSbySeason",i,".csv"), 
#             quote = FALSE, row.names = FALSE)}

# new pit section
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)


  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,2], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,2], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,2], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,2], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,2], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,3], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,3], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,3], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,3], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,3], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,4], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,4], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,4], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,4], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,4], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  par(mfrow=c(2,3))
  hist(PIT_BLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_BLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_test_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_CBLP_train_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  hist(PIT_FSTW_S1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
  
  
par(mfrow=c(8,3))
for(i in 1:5){
  hist(PIT_Beta_m1_train_S1[,i], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:5){
  hist(PIT_Beta_m1_test_S1[,i], breaks=seq(0,1,0.1),freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
for(i in 1:5){
  hist(PIT_Beta_m2_test_S1[,i], breaks=seq(0,1,0.1),freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:5){
  hist(tt1s1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
    hist(tt2s1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
    hist(tt3s1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
      hist(tt4s1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
      hist(tt5s1[,1], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:5){
  hist(PIT_CBLP_test_S5[,i], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:5){
  hist(PIT_CBLP_test_S6[,i], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:5){
  hist(PIT_BLP_test_S7[,i], freq=F, ylim= c(0, 2.5), xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
#dev.off()


# Mean log score


# variance section
varPIT<-data.frame(round(
  rbind(apply(onewkPITs, 2, var), apply(twowkPITs, 2, var), apply(thwkPITs, 2, var),
        apply(fowkPITs, 2, var),apply(peakwkPITs, 2, var)),3))
rownames(varPIT)<-targets

varPIT

```

# Prospective 

```{r, echo=FALSE}
# get real-time data
ecdf_mat2 <- matrix(NA,ncol=21,nrow=nrow(c5))

comp_ecdf2<-read.csv("scores/rtDis.csv")  %>%
  dplyr::filter(!(model_name %in% noncomp_lst)) %>%
  mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"), 
                         paste(year-1, year, sep= "/"))) %>%
  select(-"year",-"forecast_week") 
levels(comp_ecdf2$model_name)[levels(comp_ecdf2$model_name)=="CUBMA"] <- "CU_BMA"
comp_ecdf2 <- comp_ecdf2 %>%
  dplyr::filter(Season==testSeason,calendar_week %in% wk_range) 
# get pits for real time data
tar_type_test2<-list()
for (i in 1:length(targets)){
  ecdf_mat2 <- matrix(NA,ncol=21,nrow=nrow(c1_test))
for(j in 1:length(model_list)){
  comp_tar2<-  comp_ecdf2 %>%
    dplyr::filter(model_name == model_list[j]) 
  ecdf_mat2[,j]<-target_pit_values_new2(comp_tar2,targets[i])
}
    tar_type_test2[[i]]<- ecdf_mat2
}


#test pits
tt1<-tar_type_test2[[1]]
tt2<-tar_type_test2[[2]]
tt3<-tar_type_test2[[3]]
tt4<-tar_type_test2[[4]]
tt5<-tar_type_test2[[5]]

write.csv(data.frame(tt1), file="scores/cdf_test1.csv", quote = FALSE, row.names = FALSE)
write.csv(data.frame(tt2), file="scores/cdf_test2.csv", quote = FALSE, row.names = FALSE)
write.csv(data.frame(tt3), file="scores/cdf_test3.csv", quote = FALSE, row.names = FALSE)
write.csv(data.frame(tt4), file="scores/cdf_test4.csv", quote = FALSE, row.names = FALSE)
write.csv(data.frame(tt5), file="scores/cdf_test5.csv", quote = FALSE, row.names = FALSE)


# to not have to run test set ecdf again
tt1pros<-read.csv("scores/cdf_test1.csv") %>% as.matrix()
tt2pros<-read.csv("scores/cdf_test2.csv") %>% as.matrix()
tt3pros<-read.csv("scores/cdf_test3.csv") %>% as.matrix()
tt4pros<-read.csv("scores/cdf_test4.csv") %>% as.matrix()
tt5pros<-read.csv("scores/cdf_test5.csv") %>% as.matrix()
```


## Evaluation

Explore PIT plots of component models and TW ensemble.

```{r}
# Parameter values

# table <- matrix(NA, nrow = 3, ncol = 6, 
#                 dimnames = list(forecast_names[4:6], 
#                                 c("w1", "w2", "w3", "c", "alpha", "beta")))
# table[1,] <- c(weights_TLP, rep(NA, 3))
# table[2,] <- c(pars_SLP[-1], pars_SLP[1], rep(NA, 2))
# table[3,] <- c(pars_BLP[-c(1,2)], NA, pars_BLP[1:2])

# Overview over estimated parameters
# NA's denote parameter that are not part of the corresponding model
# round(table, 2)

# PIT for FS-TW
rt_data<-read.csv("scores/rtDis.csv")  %>%
  mutate(Season = ifelse(calendar_week > 30, paste(year, year+1, sep = "/"), 
                         paste(year-1, year, sep= "/")))
levels(rt_data$model_name)[levels(rt_data$model_name)=="CUBMA"] <- "CU_BMA"
rt_data2<-rt_data %>%
    dplyr::filter(!(model_name %in% noncomp_lst))
FSTW<-read.csv("scores/rtDis.csv") %>%
  dplyr::filter(model_name=="target-based-weights") 
rm(rt_data)
PIT_FSTW<-matrix(NA,ncol=5,nrow=nrow(combBLP_test))
for(i in 1:length(targets)){
  PIT_FSTW[,i]<-target_pit_values_new2(FSTW, targets[i])
}
# pits for components
comp_pits_all<-list()
for(i in 1:length(targets)){
  PIT_comp<-matrix(NA,ncol=length(model_list),nrow=length(PIT_FSTW))
for(j in 1:length(model_list)){
  model_rt<-rt_data2 %>%
    dplyr::filter(model_name==model_list[j]) 
  PIT_comp[,j]<-target_pit_values_new2(model_rt, targets[i])
}
  comp_pits_all[[i]]<-PIT_comp
}
# write.csv(data.frame(comp_pits_all), file="scores/comp_test.csv", quote = FALSE, row.names = FALSE)

# make BLP and cBLP combined into pits
PIT_blp_test <- matrix(c(pbeta(combBLP_test[,1], shape1 = t1wk[1], shape2 = t1wk[2]),
                         pbeta(combBLP_test[,2], shape1 = t2wk[1], shape2 = t2wk[2]),
                         pbeta(combBLP_test[,3], shape1 = t3wk[1], shape2 = t3wk[2]),
                         pbeta(combBLP_test[,4], shape1 = t4wk[1], shape2 = t4wk[2]),
                         pbeta(combBLP_test[,5], shape1 = t5wk[1], shape2 = t5wk[2])),
                         ncol=5,byrow=FALSE,dimnames=NULL)

PIT_cblp_test <- matrix(c(pbeta(combCBLP_test[,1], shape1 = ct1wk[1], shape2 = ct1wk[2]),
                         pbeta(combCBLP_test[,2], shape1 = ct2wk[1], shape2 = ct2wk[2]),
                         pbeta(combCBLP_test[,3], shape1 = ct3wk[1], shape2 = ct3wk[2]),
                         pbeta(combCBLP_test[,4], shape1 = ct4wk[1], shape2 = ct4wk[2]),
                         pbeta(combCBLP_test[,5], shape1 = ctpwk[1], shape2 = ctpwk[2])),
                         ncol=5,byrow=FALSE,dimnames=NULL)
bcomp_test1<-matrix(NA,ncol=ncol(comp_pits_all[[1]]),nrow=nrow(comp_pits_all[[1]]))
for(i in 1:length(model_list)){
  bcomp_test1[,i]<-pbeta(comp_pits_all[[1]][,i], shape1 = indt1wk[i,1], shape2 = indt1wk[i,2])
}
bcomp_test2<-matrix(NA,ncol=ncol(comp_pits_all[[2]]),nrow=nrow(comp_pits_all[[2]]))
for(i in 1:length(model_list)){
  bcomp_test2[,i]<-pbeta(comp_pits_all[[2]][,i], shape1 = indt2wk[i,1], shape2 = indt2wk[i,2])
}
bcomp_test3<-matrix(NA,ncol=ncol(comp_pits_all[[3]]),nrow=nrow(comp_pits_all[[3]]))
for(i in 1:length(model_list)){
  bcomp_test3[,i]<-pbeta(comp_pits_all[[3]][,i], shape1 = indt3wk[i,1], shape2 = indt3wk[i,2])
}
bcomp_test4<-matrix(NA,ncol=ncol(comp_pits_all[[4]]),nrow=nrow(comp_pits_all[[4]]))
for(i in 1:length(model_list)){
  bcomp_test4[,i]<-pbeta(comp_pits_all[[4]][,i], shape1 = indt4wk[i,1], shape2 = indt4wk[i,2])
}
bcomp_test5<-matrix(NA,ncol=ncol(comp_pits_all[[5]]),nrow=nrow(comp_pits_all[[5]]))
for(i in 1:length(model_list)){
  bcomp_test5[,i]<-pbeta(comp_pits_all[[5]][,i], shape1 = indt5wk[i,1], shape2 = indt5wk[i,2])
}


# target matrix
# onewkPITs<-matrix(cbind(comp_pits_all[[1]],bcomp_test1,PIT_FSTW[,1],PIT_blpexp_test[,1],PIT_cblp_test[,1]),
#                                         ncol=45,nrow=1540,byrow=FALSE,dimnames=NULL)
# twowkPITs<-matrix(cbind(comp_pits_all[[2]],bcomp_test2,PIT_FSTW[,2],PIT_blpexp_test[,2],PIT_cblp_test[,2]),
#                       ncol=45,nrow=1540,byrow=FALSE,dimnames=NULL)
# thwkPITs<-matrix(cbind(comp_pits_all[[3]],bcomp_test3,PIT_FSTW[,3],PIT_blpexp_test[,3],PIT_cblp_test[,3]),
#                  ncol=45,nrow=1540,byrow=FALSE,dimnames=NULL)
# fowkPITs<-matrix(cbind(comp_pits_all[[4]],bcomp_test4,PIT_FSTW[,4],PIT_blpexp_test[,4],PIT_cblp_test[,4]),
#                  ncol=45,nrow=1540,byrow=FALSE,dimnames=NULL)
# peakwkPITs<-matrix(cbind(comp_pits_all[[5]],bcomp_test5,PIT_FSTW[,5],PIT_blpexp_test[,5],PIT_cblp_test[,5])
#                    ,ncol=45,nrow=1540,byrow=FALSE,dimnames=NULL)

onewkPITs<-matrix(cbind(PIT_FSTW[,1],PIT_blp_test[,1]),ncol=2,nrow=308,byrow=FALSE,dimnames=NULL)
twowkPITs<-matrix(cbind(PIT_FSTW[,2],PIT_blp_test[,2]),ncol=2,nrow=308,byrow=FALSE,dimnames=NULL)
thwkPITs<-matrix(cbind(PIT_FSTW[,3],PIT_blp_test[,3]),ncol=2,nrow=308,byrow=FALSE,dimnames=NULL)
fowkPITs<-matrix(cbind(PIT_FSTW[,4],PIT_blp_test[,4]),ncol=2,nrow=308,byrow=FALSE,dimnames=NULL)
peakwkPITs<-matrix(cbind(PIT_FSTW[,5],PIT_blp_test[,5]),ncol=2,nrow=308,byrow=FALSE,dimnames=NULL)

# colnames(onewkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
# colnames(twowkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
# colnames(thwkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
# colnames(fowkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
# colnames(peakwkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")

colnames(onewkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
colnames(twowkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
colnames(thwkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
colnames(fowkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")
colnames(peakwkPITs)<-c(model_list,paste("Beta",model_list,sep="-"),"FSNetwork-TW","nBLP","cBLP")


# write.csv(onewkPITs, file="./target1pitv2.csv", quote = FALSE, row.names = FALSE)
# write.csv(twowkPITs, file="./target2pitv2.csv", quote = FALSE, row.names = FALSE)
# write.csv(thwkPITs, file="./target3pitv2.csv", quote = FALSE, row.names = FALSE)
# write.csv(fowkPITs, file="./target4pitv2.csv", quote = FALSE, row.names = FALSE)
# write.csv(peakwkPITs, file="./target5pitv2.csv", quote = FALSE, row.names = FALSE)

# new pit section
par(mfrow=c(8,3))
for(i in 1:2){
  hist(onewkPITs[,i], freq=F, ylim= c(0, 2.5), main= colnames(onewkPITs)[i], xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:2){
  hist(twowkPITs[,i], freq=F, ylim= c(0, 2.5), main= colnames(onewkPITs)[i], xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:2){
  hist(thwkPITs[,i], freq=F, ylim= c(0, 2.5), main= colnames(onewkPITs)[i], xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:2){
  hist(fowkPITs[,i], freq=F, ylim= c(0, 2.5), main= colnames(onewkPITs)[i], xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
par(mfrow=c(8,3))
for(i in 1:2){
  hist(peakwkPITs[,i], freq=F, ylim= c(0, 2.5), main= colnames(onewkPITs)[i], xlab='PIT values')
  abline(h=1, col=4, lty=3)
}
#dev.off()

# variance section
varPIT<-data.frame(round(
  rbind(apply(onewkPITs, 2, var), apply(twowkPITs, 2, var), apply(thwkPITs, 2, var),
        apply(fowkPITs, 2, var),apply(peakwkPITs, 2, var)),3))
rownames(varPIT)<-targets

varPIT
# Mean log score
# LS(f,y) = -log(f(y))
# mls <- matrix(NA, nrow = 6, ncol = 2, dimnames = list(forecast_names, 
#                                                       c("Training", "Test")))
# for(j in 1:2){
#   ind <- if(j == 1){ind_est}else{ind_est}
#   for(i in 1:3) mls[i, j]  <- -mean(ll_normal(Y = Y[ind,], mu = means[ind, i], 
#                                               sd = sds[ind, i]))
#   mls[4, j] <- - mean(wrapper_TLP(Y = Y[ind], vars = vars[ind, ], 
#                                   coefs = coefs, weights = weights_TLP, eval = FALSE))
#   mls[5, j] <- - mean(wrapper_SLP(Y = Y[ind], vars = vars[ind, ], 
#                                   coefs = coefs, pars = pars_SLP, eval = FALSE))
#   mls[6, j] <- - mean(wrapper_BLP(Y = Y[ind], vars = vars[ind, ], 
#                                   coefs = coefs, pars = pars_BLP, eval = FALSE))
# }
# # Mean log scores over the training and the test sample
# round(mls, 2)
```